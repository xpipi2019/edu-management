# 数据库功能模块代码示例


## 系统概述
本数据库设计面向教育管理系统，采用模块化设计实现以下核心功能：
- **认证授权**：用户登录验证、角色权限管理
- **教务管理**：教师/学生信息维护、课程编排、成绩管理
- **教学资源**：教室调度、排课冲突检测、教学评价
- **数据分析**：成绩统计、教学效果分析、学生行为追踪

---

## 注意事项

在使用触发器时需要注意，是否会频繁调用拖累数据库的运行速度，可以在前端通过软实现的方式实现后端的一部分功能。

---


## 1. 认证模块 (authApi)

### 登录页面 - 用户登录验证
```sql
-- 查询代码 - 用户登录验证
SELECT u.*, GROUP_CONCAT(r.role_code) as roles
FROM user u
LEFT JOIN user_role ur ON u.user_id = ur.user_id
LEFT JOIN role r ON ur.role_id = r.role_id
WHERE u.username = ? AND u.status = 1;

-- 存储过程 - 用户登录
DELIMITER $$
CREATE PROCEDURE sp_user_login(
    IN p_username VARCHAR(50),
    IN p_password VARCHAR(255),
    OUT p_result INT,
    OUT p_message VARCHAR(255),
    OUT p_user_id INT
)
BEGIN
    DECLARE v_user_count INT DEFAULT 0;
    DECLARE v_stored_password VARCHAR(255);
    DECLARE v_user_status INT;
    
    SELECT COUNT(*), password, status, user_id
    INTO v_user_count, v_stored_password, v_user_status, p_user_id
    FROM user
    WHERE username = p_username;
    
    IF v_user_count = 0 THEN
        SET p_result = 1;
        SET p_message = '用户名或密码错误';
    ELSEIF v_user_status != 1 THEN
        SET p_result = 2;
        SET p_message = '用户已被禁用';
    ELSEIF v_stored_password != p_password THEN
        SET p_result = 1;
        SET p_message = '用户名或密码错误';
    ELSE
        SET p_result = 0;
        SET p_message = '登录成功';
    END IF;
END$$
DELIMITER ;
```

### 个人中心页面 - 获取用户信息
```sql
-- 查询代码 - 获取用户详细信息
SELECT u.*, GROUP_CONCAT(r.role_name) as role_names
FROM user u
LEFT JOIN user_role ur ON u.user_id = ur.user_id
LEFT JOIN role r ON ur.role_id = r.role_id
WHERE u.user_id = ?;
```

### 个人中心页面 - 修改密码
```sql
-- 更新代码 - 修改密码
UPDATE user 
SET password = ?, updated_at = NOW() 
WHERE user_id = ? AND password = ?;
```

## 2. 用户管理模块 (userApi)

### 用户管理页面 - 用户列表查询
```sql
-- 查询代码 - 分页查询用户列表
SELECT u.*, GROUP_CONCAT(r.role_name) as role_names
FROM user u
LEFT JOIN user_role ur ON u.user_id = ur.user_id
LEFT JOIN role r ON ur.role_id = r.role_id
WHERE 1=1
  AND (? IS NULL OR u.username LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR u.real_name LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR u.email LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR u.status = ?)
GROUP BY u.user_id
ORDER BY u.created_at DESC
LIMIT ? OFFSET ?;

-- 查询总数
SELECT COUNT(DISTINCT u.user_id)
FROM user u
LEFT JOIN user_role ur ON u.user_id = ur.user_id
LEFT JOIN role r ON ur.role_id = r.role_id
WHERE 1=1
  AND (? IS NULL OR u.username LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR u.real_name LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR u.email LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR u.status = ?);
```

### 用户管理页面 - 创建用户
```sql
-- 插入代码 - 创建用户
INSERT INTO user (username, real_name, email, phone, password, status, created_at, updated_at)
VALUES (?, ?, ?, ?, '123456', ?, NOW(), NOW());

-- 插入用户角色关联
INSERT INTO user_role (user_id, role_id, assigned_by)
VALUES (?, ?, ?);

-- 存储过程 - 创建用户
DELIMITER $$
CREATE PROCEDURE sp_create_user(
    IN p_username VARCHAR(50),
    IN p_real_name VARCHAR(20),
    IN p_email VARCHAR(100),
    IN p_phone VARCHAR(11),
    IN p_status TINYINT,
    IN p_role_ids TEXT,
    IN p_assigned_by INT,
    OUT p_user_id INT
)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE role_id INT;
    DECLARE role_cursor CURSOR FOR 
        SELECT CAST(TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(p_role_ids, ',', numbers.n), ',', -1)) AS UNSIGNED) as role_id
        FROM (SELECT 1 n UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5) numbers
        WHERE CHAR_LENGTH(p_role_ids) - CHAR_LENGTH(REPLACE(p_role_ids, ',', '')) >= numbers.n - 1
        AND p_role_ids IS NOT NULL AND p_role_ids != '';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    START TRANSACTION;
    
    INSERT INTO user (username, real_name, email, phone, password, status, created_at, updated_at)
    VALUES (p_username, p_real_name, p_email, p_phone, '123456', p_status, NOW(), NOW());
    
    SET p_user_id = LAST_INSERT_ID();
    
    IF p_role_ids IS NOT NULL AND p_role_ids != '' THEN
        OPEN role_cursor;
        read_loop: LOOP
            FETCH role_cursor INTO role_id;
            IF done THEN
                LEAVE read_loop;
            END IF;
            INSERT INTO user_role (user_id, role_id, assigned_by) VALUES (p_user_id, role_id, p_assigned_by);
        END LOOP;
        CLOSE role_cursor;
    END IF;
    
    COMMIT;
END$$
DELIMITER ;
```

### 用户管理页面 - 更新用户
```sql
-- 更新代码 - 更新用户信息
UPDATE user 
SET real_name = ?, email = ?, phone = ?, status = ?, updated_at = NOW()
WHERE user_id = ?;

-- 删除旧的角色关联
DELETE FROM user_role WHERE user_id = ?;

-- 插入新的角色关联
INSERT INTO user_role (user_id, role_id, assigned_by) VALUES (?, ?, ?);
```

### 用户管理页面 - 删除用户
```sql
-- 删除代码 - 删除用户（级联删除相关数据）
DELETE FROM user WHERE user_id = ?;
```

### 用户管理页面 - 批量删除用户
```sql
-- 删除代码 - 批量删除用户
DELETE FROM user WHERE user_id IN (?, ?, ?);
```

### 用户管理页面 - 重置密码
```sql
-- 更新代码 - 重置密码
UPDATE user 
SET password = '123456', updated_at = NOW()
WHERE user_id = ?;
```

### 用户管理页面 - 切换用户状态
```sql
-- 更新代码 - 切换用户状态
UPDATE user 
SET status = ?, updated_at = NOW()
WHERE user_id = ?;
```

## 3. 角色管理模块 (roleApi)

### 角色管理页面 - 角色列表查询
```sql
-- 查询代码 - 分页查询角色列表
SELECT r.*, GROUP_CONCAT(p.permission_name) as permission_names
FROM role r
LEFT JOIN role_permission rp ON r.role_id = rp.role_id
LEFT JOIN permission p ON rp.permission_id = p.permission_id
GROUP BY r.role_id
ORDER BY r.role_id
LIMIT ? OFFSET ?;

-- 查询所有角色
SELECT * FROM role WHERE status = 1 ORDER BY role_id;
```

### 角色管理页面 - 创建角色
```sql
-- 插入代码 - 创建角色
INSERT INTO role (role_name, role_code, description, status, created_at)
VALUES (?, ?, ?, ?, NOW());

-- 插入角色权限关联
INSERT INTO role_permission (role_id, permission_id)
VALUES (?, ?);

-- 存储过程 - 创建角色
DELIMITER $$
CREATE PROCEDURE sp_create_role(
    IN p_role_name VARCHAR(50),
    IN p_role_code VARCHAR(20),
    IN p_description TEXT,
    IN p_status TINYINT,
    IN p_permission_ids TEXT,
    OUT p_role_id INT
)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE permission_id INT;
    DECLARE perm_cursor CURSOR FOR 
        SELECT CAST(TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(p_permission_ids, ',', numbers.n), ',', -1)) AS UNSIGNED) as permission_id
        FROM (SELECT 1 n UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5) numbers
        WHERE CHAR_LENGTH(p_permission_ids) - CHAR_LENGTH(REPLACE(p_permission_ids, ',', '')) >= numbers.n - 1
        AND p_permission_ids IS NOT NULL AND p_permission_ids != '';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    START TRANSACTION;
    
    INSERT INTO role (role_name, role_code, description, status, created_at)
    VALUES (p_role_name, p_role_code, p_description, p_status, NOW());
    
    SET p_role_id = LAST_INSERT_ID();
    
    IF p_permission_ids IS NOT NULL AND p_permission_ids != '' THEN
        OPEN perm_cursor;
        read_loop: LOOP
            FETCH perm_cursor INTO permission_id;
            IF done THEN
                LEAVE read_loop;
            END IF;
            INSERT INTO role_permission (role_id, permission_id) VALUES (p_role_id, permission_id);
        END LOOP;
        CLOSE perm_cursor;
    END IF;
    
    COMMIT;
END$$
DELIMITER ;
```

### 角色管理页面 - 更新角色
```sql
-- 更新代码 - 更新角色信息
UPDATE role 
SET role_name = ?, role_code = ?, description = ?, status = ?
WHERE role_id = ?;

-- 删除旧的权限关联
DELETE FROM role_permission WHERE role_id = ?;

-- 插入新的权限关联
INSERT INTO role_permission (role_id, permission_id) VALUES (?, ?);
```

### 角色管理页面 - 删除角色
```sql
-- 删除代码 - 删除角色
DELETE FROM role WHERE role_id = ?;
```

## 4. 权限管理模块 (permissionApi)

### 权限管理页面 - 权限列表查询
```sql
-- 查询代码 - 获取所有权限
SELECT * FROM permission WHERE status = 1 ORDER BY module, permission_id;

-- 查询代码 - 按模块分组获取权限
SELECT module, permission_id, permission_name, permission_code, description
FROM permission
WHERE status = 1
ORDER BY module, permission_id;
```

## 5. 部门管理模块 (departmentApi)

### 部门管理页面 - 部门列表查询
```sql
-- 查询代码 - 分页查询部门列表
SELECT * FROM department 
WHERE status = 1
ORDER BY dept_id
LIMIT ? OFFSET ?;

-- 查询代码 - 获取所有部门
SELECT * FROM department WHERE status = 1 ORDER BY dept_id;

-- 查询代码 - 获取部门树形结构
SELECT d1.*, d2.dept_name as parent_name
FROM department d1
LEFT JOIN department d2 ON d1.parent_id = d2.dept_id
WHERE d1.status = 1
ORDER BY d1.parent_id, d1.dept_id;
```

### 部门管理页面 - 创建部门
```sql
-- 插入代码 - 创建部门
INSERT INTO department (dept_name, dept_code, parent_id, description, status)
VALUES (?, ?, ?, ?, ?);
```

### 部门管理页面 - 更新部门
```sql
-- 更新代码 - 更新部门信息
UPDATE department 
SET dept_name = ?, dept_code = ?, parent_id = ?, description = ?, status = ?
WHERE dept_id = ?;
```

### 部门管理页面 - 删除部门
```sql
-- 删除代码 - 删除部门（检查是否有子部门）
SELECT COUNT(*) FROM department WHERE parent_id = ?;

DELETE FROM department WHERE dept_id = ? AND NOT EXISTS (
    SELECT 1 FROM department d2 WHERE d2.parent_id = ?
);

-- 触发器 - 防止删除有子部门的部门
DELIMITER $$
CREATE TRIGGER tr_prevent_parent_dept_delete
BEFORE DELETE ON department
FOR EACH ROW
BEGIN
    DECLARE child_count INT;
    SELECT COUNT(*) INTO child_count FROM department WHERE parent_id = OLD.dept_id;
    IF child_count > 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '该部门下有子部门，无法删除';
    END IF;
END$$
DELIMITER ;
```

## 6. 教师管理模块 (teacherApi)

### 教师管理页面 - 教师列表查询
```sql
-- 查询代码 - 分页查询教师列表
SELECT t.*, u.username, u.real_name, u.email, u.phone, u.status as user_status,
       d.dept_name
FROM teacher t
JOIN user u ON t.user_id = u.user_id
LEFT JOIN department d ON t.dept_id = d.dept_id
WHERE 1=1
  AND (? IS NULL OR t.teacher_no LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR t.dept_id = ?)
  AND (? IS NULL OR t.title = ?)
  AND (? IS NULL OR t.status = ?)
  AND (? IS NULL OR u.real_name LIKE CONCAT('%', ?, '%'))
ORDER BY t.teacher_id DESC
LIMIT ? OFFSET ?;

-- 查询代码 - 教师信息视图查询
SELECT t.teacher_no, u.real_name, t.title, d.dept_name, t.hire_date, t.status
FROM teacher t
JOIN user u ON t.user_id = u.user_id
LEFT JOIN department d ON t.dept_id = d.dept_id
WHERE 1=1
  AND (? IS NULL OR t.teacher_no LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR t.title = ?)
  AND (? IS NULL OR u.real_name LIKE CONCAT('%', ?, '%'))
ORDER BY t.teacher_id DESC
LIMIT ? OFFSET ?;
```

### 教师管理页面 - 创建教师
```sql
-- 存储过程 - 创建教师
DELIMITER $$
CREATE PROCEDURE sp_create_teacher(
    IN p_username VARCHAR(50),
    IN p_real_name VARCHAR(20),
    IN p_email VARCHAR(100),
    IN p_phone VARCHAR(11),
    IN p_user_status TINYINT,
    IN p_teacher_no VARCHAR(20),
    IN p_dept_id INT,
    IN p_title VARCHAR(20),
    IN p_hire_date DATE,
    IN p_teacher_status TINYINT,
    OUT p_teacher_id INT
)
BEGIN
    DECLARE v_user_id INT;
    
    START TRANSACTION;
    
    INSERT INTO user (username, real_name, email, phone, password, status, created_at, updated_at)
    VALUES (p_username, p_real_name, p_email, p_phone, '123456', p_user_status, NOW(), NOW());
    
    SET v_user_id = LAST_INSERT_ID();
    
    INSERT INTO teacher (user_id, teacher_no, dept_id, title, hire_date, status)
    VALUES (v_user_id, p_teacher_no, p_dept_id, p_title, p_hire_date, p_teacher_status);
    
    SET p_teacher_id = LAST_INSERT_ID();
    
    COMMIT;
END$$
DELIMITER ;
```

### 教师管理页面 - 更新教师
```sql
-- 更新代码 - 更新教师信息
UPDATE user 
SET real_name = ?, email = ?, phone = ?, status = ?, updated_at = NOW()
WHERE user_id = (SELECT user_id FROM teacher WHERE teacher_id = ?);

UPDATE teacher 
SET teacher_no = ?, dept_id = ?, title = ?, hire_date = ?, status = ?
WHERE teacher_id = ?;
```

### 教师管理页面 - 删除教师
```sql
-- 删除代码 - 删除教师
DELETE FROM teacher WHERE teacher_id = ?;
```

### 教师管理页面 - 按部门查询教师
```sql
-- 查询代码 - 按部门查询教师
SELECT t.*, u.real_name
FROM teacher t
JOIN user u ON t.user_id = u.user_id
WHERE t.dept_id = ? AND t.status = 1;
```

## 7. 学生管理模块 (studentApi)

### 学生管理页面 - 学生列表查询
```sql
-- 查询代码 - 分页查询学生列表
SELECT s.*, u.username, u.real_name, u.email, u.phone, u.status as user_status,
       d.dept_name
FROM student s
JOIN user u ON s.user_id = u.user_id
LEFT JOIN department d ON s.dept_id = d.dept_id
WHERE 1=1
  AND (? IS NULL OR s.student_no LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR s.dept_id = ?)
  AND (? IS NULL OR s.class_name LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR s.grade = ?)
  AND (? IS NULL OR s.enrollment_year = ?)
  AND (? IS NULL OR u.real_name LIKE CONCAT('%', ?, '%'))
ORDER BY s.student_id DESC
LIMIT ? OFFSET ?;

-- 查询代码 - 学生信息视图查询
SELECT s.student_no, u.real_name, s.class_name, s.grade, s.enrollment_year, d.dept_name
FROM student s
JOIN user u ON s.user_id = u.user_id
LEFT JOIN department d ON s.dept_id = d.dept_id
WHERE 1=1
  AND (? IS NULL OR s.student_no LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR s.class_name LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR s.grade = ?)
  AND (? IS NULL OR s.enrollment_year = ?)
  AND (? IS NULL OR u.real_name LIKE CONCAT('%', ?, '%'))
ORDER BY s.student_id DESC
LIMIT ? OFFSET ?;
```

### 学生管理页面 - 创建学生
```sql
-- 存储过程 - 创建学生
DELIMITER $$
CREATE PROCEDURE sp_create_student(
    IN p_username VARCHAR(50),
    IN p_real_name VARCHAR(20),
    IN p_email VARCHAR(100),
    IN p_phone VARCHAR(11),
    IN p_user_status TINYINT,
    IN p_student_no VARCHAR(20),
    IN p_dept_id INT,
    IN p_class_name VARCHAR(50),
    IN p_grade INT,
    IN p_enrollment_year YEAR,
    OUT p_student_id INT
)
BEGIN
    DECLARE v_user_id INT;
    
    START TRANSACTION;
    
    INSERT INTO user (username, real_name, email, phone, password, status, created_at, updated_at)
    VALUES (p_username, p_real_name, p_email, p_phone, '123456', p_user_status, NOW(), NOW());
    
    SET v_user_id = LAST_INSERT_ID();
    
    INSERT INTO student (user_id, student_no, dept_id, class_name, grade, enrollment_year)
    VALUES (v_user_id, p_student_no, p_dept_id, p_class_name, p_grade, p_enrollment_year);
    
    SET p_student_id = LAST_INSERT_ID();
    
    COMMIT;
END$$
DELIMITER ;
```

### 学生管理页面 - 更新学生
```sql
-- 更新代码 - 更新学生信息
UPDATE user 
SET real_name = ?, email = ?, phone = ?, status = ?, updated_at = NOW()
WHERE user_id = (SELECT user_id FROM student WHERE student_id = ?);

UPDATE student 
SET student_no = ?, dept_id = ?, class_name = ?, grade = ?, enrollment_year = ?
WHERE student_id = ?;
```

### 学生管理页面 - 删除学生
```sql
-- 删除代码 - 删除学生
DELETE FROM student WHERE student_id = ?;
```

### 学生成绩页面 - 获取学生成绩单
```sql
-- 查询代码 - 获取学生成绩单
SELECT s.student_no, u.real_name, s.class_name, s.grade, s.enrollment_year,
       c.course_name, c.credits, g.usual_score, g.exam_score, g.final_score,
       g.grade_point, co.semester
FROM student s
JOIN user u ON s.user_id = u.user_id
JOIN enrollment e ON s.student_id = e.student_id
JOIN course_offering co ON e.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
WHERE s.student_id = ?
ORDER BY co.semester, c.course_name;

-- 存储过程 - 计算学生GPA
DELIMITER $$
CREATE PROCEDURE sp_calculate_student_gpa(
    IN p_student_id INT,
    OUT p_gpa DECIMAL(3,2),
    OUT p_total_credits DECIMAL(3,1)
)
BEGIN
    DECLARE v_total_grade_points DECIMAL(10,2) DEFAULT 0;
    DECLARE v_total_credits DECIMAL(10,1) DEFAULT 0;
    
    SELECT 
        SUM(g.grade_point * c.credits),
        SUM(CASE WHEN g.final_score >= 60 THEN c.credits ELSE 0 END)
    INTO v_total_grade_points, v_total_credits
    FROM student s
    JOIN enrollment e ON s.student_id = e.student_id
    JOIN course_offering co ON e.offering_id = co.offering_id
    JOIN course c ON co.course_id = c.course_id
    JOIN grade g ON e.enrollment_id = g.enrollment_id
    WHERE s.student_id = p_student_id AND g.final_score IS NOT NULL;
    
    SET p_total_credits = v_total_credits;
    SET p_gpa = CASE WHEN v_total_credits > 0 THEN v_total_grade_points / v_total_credits ELSE 0 END;
END$$
DELIMITER ;
```

## 8. 课程管理模块 (courseApi)

### 课程管理页面 - 课程列表查询
```sql
-- 查询代码 - 分页查询课程列表
SELECT c.*, d.dept_name
FROM course c
LEFT JOIN department d ON c.dept_id = d.dept_id
WHERE 1=1
  AND (? IS NULL OR c.course_name LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR c.course_code LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR c.course_type = ?)
  AND (? IS NULL OR c.status = ?)
ORDER BY c.course_id DESC
LIMIT ? OFFSET ?;

-- 查询代码 - 获取所有课程
SELECT * FROM course WHERE status = 1 ORDER BY course_name;

-- 查询代码 - 按类型查询课程
SELECT * FROM course WHERE course_type = ? AND status = 1;
```

### 课程管理页面 - 创建课程
```sql
-- 插入代码 - 创建课程
INSERT INTO course (course_name, course_code, dept_id, credits, hours, course_type, description, status)
VALUES (?, ?, ?, ?, ?, ?, ?, ?);
```

### 课程管理页面 - 更新课程
```sql
-- 更新代码 - 更新课程信息
UPDATE course 
SET course_name = ?, course_code = ?, dept_id = ?, credits = ?, hours = ?, 
    course_type = ?, description = ?, status = ?
WHERE course_id = ?;
```

### 课程管理页面 - 删除课程
```sql
-- 删除代码 - 删除课程
DELETE FROM course WHERE course_id = ?;

-- 触发器 - 删除课程前检查是否有开课记录
DELIMITER $$
CREATE TRIGGER tr_prevent_course_delete_with_offerings
BEFORE DELETE ON course
FOR EACH ROW
BEGIN
    DECLARE offering_count INT;
    SELECT COUNT(*) INTO offering_count FROM course_offering WHERE course_id = OLD.course_id;
    IF offering_count > 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '该课程已有开课记录，无法删除';
    END IF;
END$$
DELIMITER ;
```

## 9. 开课管理模块 (courseOfferingApi)

### 开课管理页面 - 开课列表查询
```sql
-- 查询代码 - 分页查询开课列表
SELECT co.*, c.course_name, c.course_code, c.credits,
       t.teacher_no, u.real_name as teacher_name
FROM course_offering co
JOIN course c ON co.course_id = c.course_id
JOIN teacher t ON co.teacher_id = t.teacher_id
JOIN user u ON t.user_id = u.user_id
WHERE 1=1
  AND (? IS NULL OR co.course_id = ?)
  AND (? IS NULL OR co.teacher_id = ?)
  AND (? IS NULL OR co.semester = ?)
  AND (? IS NULL OR co.status = ?)
ORDER BY co.offering_id DESC
LIMIT ? OFFSET ?;

-- 查询代码 - 开课信息视图查询
SELECT co.offering_id, c.course_name, c.course_code, c.credits,
       u.real_name as teacher_name, co.semester, co.max_students, co.current_students
FROM course_offering co
JOIN course c ON co.course_id = c.course_id
JOIN teacher t ON co.teacher_id = t.teacher_id
JOIN user u ON t.user_id = u.user_id
WHERE (? IS NULL OR co.semester = ?)
ORDER BY co.offering_id DESC
LIMIT ? OFFSET ?;
```

### 开课管理页面 - 创建开课
```sql
-- 插入代码 - 创建开课
INSERT INTO course_offering (course_id, teacher_id, semester, max_students, current_students, status)
VALUES (?, ?, ?, ?, 0, ?);
```

### 开课管理页面 - 更新开课
```sql
-- 更新代码 - 更新开课信息
UPDATE course_offering 
SET course_id = ?, teacher_id = ?, semester = ?, max_students = ?, status = ?
WHERE offering_id = ?;
```

### 开课管理页面 - 删除开课
```sql
-- 删除代码 - 删除开课
DELETE FROM course_offering WHERE offering_id = ?;

-- 触发器 - 删除开课前检查是否有选课记录
DELIMITER $$
CREATE TRIGGER tr_prevent_offering_delete_with_enrollments
BEFORE DELETE ON course_offering
FOR EACH ROW
BEGIN
    DECLARE enrollment_count INT;
    SELECT COUNT(*) INTO enrollment_count FROM enrollment WHERE offering_id = OLD.offering_id;
    IF enrollment_count > 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '该开课已有选课记录，无法删除';
    END IF;
END$$
DELIMITER ;
```

### 我的课程页面 - 教师查看自己的开课
```sql
-- 查询代码 - 教师查看自己的开课
SELECT co.*, c.course_name, c.course_code, c.credits
FROM course_offering co
JOIN course c ON co.course_id = c.course_id
WHERE co.teacher_id = (
    SELECT teacher_id FROM teacher WHERE user_id = ?
)
ORDER BY co.semester DESC, c.course_name;
```

继续生成选课管理模块及后续模块的MySQL语句：

## 10. 选课管理模块 (enrollmentApi)

### 选课管理页面 - 选课列表查询
```sql
-- 查询代码 - 分页查询选课列表
SELECT e.*, s.student_no, u.real_name as student_name,
       c.course_name, c.course_code, c.credits,
       t.teacher_no, u2.real_name as teacher_name,
       co.semester
FROM enrollment e
JOIN student s ON e.student_id = s.student_id
JOIN user u ON s.user_id = u.user_id
JOIN course_offering co ON e.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
JOIN teacher t ON co.teacher_id = t.teacher_id
JOIN user u2 ON t.user_id = u2.user_id
WHERE 1=1
  AND (? IS NULL OR e.student_id = ?)
  AND (? IS NULL OR e.offering_id = ?)
  AND (? IS NULL OR e.status = ?)
ORDER BY e.enrollment_date DESC
LIMIT ? OFFSET ?;
```

### 选课页面 - 学生选课
```sql
-- 存储过程 - 学生选课
DELIMITER $$
CREATE PROCEDURE sp_student_enroll(
    IN p_student_id INT,
    IN p_offering_id INT,
    OUT p_result INT,
    OUT p_message VARCHAR(255)
)
BEGIN
    DECLARE v_max_students INT;
    DECLARE v_current_students INT;
    DECLARE v_existing_count INT;
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET p_result = 3;
        SET p_message = '选课失败，系统错误';
    END;
    
    -- 检查是否已经选过该课程
    SELECT COUNT(*) INTO v_existing_count
    FROM enrollment
    WHERE student_id = p_student_id AND offering_id = p_offering_id;
    
    IF v_existing_count > 0 THEN
        SET p_result = 1;
        SET p_message = '已经选过该课程';
    ELSE
        -- 检查课程容量
        SELECT max_students, current_students
        INTO v_max_students, v_current_students
        FROM course_offering
        WHERE offering_id = p_offering_id;
        
        IF v_current_students >= v_max_students THEN
            SET p_result = 2;
            SET p_message = '课程已满';
        ELSE
            -- 执行选课
            START TRANSACTION;
            
            INSERT INTO enrollment (student_id, offering_id, enrollment_date, status)
            VALUES (p_student_id, p_offering_id, NOW(), 1);
            
            UPDATE course_offering 
            SET current_students = current_students + 1
            WHERE offering_id = p_offering_id;
            
            COMMIT;
            
            SET p_result = 0;
            SET p_message = '选课成功';
        END IF;
    END IF;
END$$
DELIMITER ;
```

### 选课页面 - 退课
```sql
-- 存储过程 - 学生退课
DELIMITER $$
CREATE PROCEDURE sp_student_withdraw(
    IN p_enrollment_id INT,
    OUT p_result INT,
    OUT p_message VARCHAR(255)
)
BEGIN
    DECLARE v_offering_id INT;
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET p_result = 1;
        SET p_message = '退课失败，系统错误';
    END;
    
    START TRANSACTION;
    
    -- 获取开课ID
    SELECT offering_id INTO v_offering_id
    FROM enrollment
    WHERE enrollment_id = p_enrollment_id;
    
    -- 删除选课记录
    DELETE FROM enrollment WHERE enrollment_id = p_enrollment_id;
    
    -- 更新开课人数
    UPDATE course_offering 
    SET current_students = current_students - 1
    WHERE offering_id = v_offering_id;
    
    COMMIT;
    
    SET p_result = 0;
    SET p_message = '退课成功';
END$$
DELIMITER ;
```

### 我的选课页面 - 学生查看自己的选课
```sql
-- 查询代码 - 学生查看自己的选课
SELECT e.*, c.course_name, c.course_code, c.credits,
       u.real_name as teacher_name, co.semester
FROM enrollment e
JOIN course_offering co ON e.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
JOIN teacher t ON co.teacher_id = t.teacher_id
JOIN user u ON t.user_id = u.user_id
WHERE e.student_id = (
    SELECT student_id FROM student WHERE user_id = ?
)
ORDER BY co.semester DESC, c.course_name;
```

### 选课审批页面 - 审批选课
```sql
-- 更新代码 - 审批选课
UPDATE enrollment 
SET status = 1
WHERE enrollment_id = ?;

-- 更新代码 - 拒绝选课
UPDATE enrollment 
SET status = 0
WHERE enrollment_id = ?;
```

## 11. 成绩管理模块 (gradeApi)

### 成绩管理页面 - 成绩列表查询
```sql
-- 查询代码 - 分页查询成绩列表
SELECT g.*, s.student_no, u.real_name as student_name,
       c.course_name, c.course_code, c.credits,
       co.semester
FROM grade g
JOIN enrollment e ON g.enrollment_id = e.enrollment_id
JOIN student s ON e.student_id = s.student_id
JOIN user u ON s.user_id = u.user_id
JOIN course_offering co ON e.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
WHERE 1=1
  AND (? IS NULL OR s.student_id = ?)
  AND (? IS NULL OR co.offering_id = ?)
  AND (? IS NULL OR co.semester = ?)
ORDER BY g.grade_id DESC
LIMIT ? OFFSET ?;
```

### 成绩录入页面 - 按开课查询成绩
```sql
-- 查询代码 - 按开课查询学生成绩
SELECT g.grade_id, s.student_no, u.real_name as student_name,
       g.usual_score, g.exam_score, g.final_score, g.grade_point,
       c.course_name, c.credits, e.enrollment_id
FROM enrollment e
JOIN student s ON e.student_id = s.student_id
JOIN user u ON s.user_id = u.user_id
JOIN course_offering co ON e.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
WHERE co.offering_id = ? AND e.status = 1
ORDER BY s.student_no;
```

### 成绩录入页面 - 更新成绩
```sql
-- 插入或更新成绩
INSERT INTO grade (enrollment_id, usual_score, exam_score, recorded_by, recorded_at)
VALUES (?, ?, ?, ?, NOW())
ON DUPLICATE KEY UPDATE
    usual_score = VALUES(usual_score),
    exam_score = VALUES(exam_score),
    recorded_by = VALUES(recorded_by),
    recorded_at = NOW();

-- 存储过程 - 批量更新成绩
DELIMITER $$
CREATE PROCEDURE sp_batch_update_grades(
    IN p_grade_data JSON
)
BEGIN
    DECLARE i INT DEFAULT 0;
    DECLARE v_count INT;
    DECLARE v_enrollment_id INT;
    DECLARE v_usual_score DECIMAL(5,2);
    DECLARE v_exam_score DECIMAL(5,2);
    DECLARE v_recorded_by INT;
    
    SET v_count = JSON_LENGTH(p_grade_data);
    
    START TRANSACTION;
    
    WHILE i < v_count DO
        SET v_enrollment_id = JSON_UNQUOTE(JSON_EXTRACT(p_grade_data, CONCAT('$[', i, '].enrollment_id')));
        SET v_usual_score = JSON_UNQUOTE(JSON_EXTRACT(p_grade_data, CONCAT('$[', i, '].usual_score')));
        SET v_exam_score = JSON_UNQUOTE(JSON_EXTRACT(p_grade_data, CONCAT('$[', i, '].exam_score')));
        SET v_recorded_by = JSON_UNQUOTE(JSON_EXTRACT(p_grade_data, CONCAT('$[', i, '].recorded_by')));
        
        INSERT INTO grade (enrollment_id, usual_score, exam_score, recorded_by, recorded_at)
        VALUES (v_enrollment_id, v_usual_score, v_exam_score, v_recorded_by, NOW())
        ON DUPLICATE KEY UPDATE
            usual_score = VALUES(usual_score),
            exam_score = VALUES(exam_score),
            recorded_by = VALUES(recorded_by),
            recorded_at = NOW();
        
        SET i = i + 1;
    END WHILE;
    
    COMMIT;
    
    SELECT CONCAT('成功更新 ', v_count, ' 条成绩记录') as result;
END$$
DELIMITER ;
```

### 我的成绩页面 - 学生查看自己的成绩
```sql
-- 查询代码 - 学生查看自己的成绩
SELECT c.course_name, c.course_code, c.credits,
       g.usual_score, g.exam_score, g.final_score, g.grade_point,
       co.semester,
       CASE 
         WHEN g.final_score >= 90 THEN '优秀'
         WHEN g.final_score >= 80 THEN '良好'
         WHEN g.final_score >= 70 THEN '中等'
         WHEN g.final_score >= 60 THEN '及格'
         ELSE '不及格'
       END as grade_level
FROM enrollment e
JOIN course_offering co ON e.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
WHERE e.student_id = (
    SELECT student_id FROM student WHERE user_id = ?
)
ORDER BY co.semester DESC, c.course_name;

-- 查询代码 - 计算学生总体成绩统计
SELECT 
    COUNT(g.grade_id) as total_courses,
    AVG(g.final_score) as average_score,
    SUM(CASE WHEN g.final_score >= 60 THEN c.credits ELSE 0 END) as earned_credits,
    SUM(c.credits) as total_credits,
    AVG(g.grade_point) as gpa
FROM enrollment e
JOIN course_offering co ON e.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
WHERE e.student_id = (
    SELECT student_id FROM student WHERE user_id = ?
) AND g.final_score IS NOT NULL;
```

## 12. 排课管理模块 (scheduleApi)

### 排课管理页面 - 排课列表查询
```sql
-- 查询代码 - 分页查询排课列表
SELECT s.*, c.course_name, c.course_code,
       u.real_name as teacher_name,
       cl.room_no, cl.building,
       co.semester,
       CASE s.day_of_week
           WHEN 1 THEN '周一'
           WHEN 2 THEN '周二'
           WHEN 3 THEN '周三'
           WHEN 4 THEN '周四'
           WHEN 5 THEN '周五'
           WHEN 6 THEN '周六'
           WHEN 7 THEN '周日'
       END as day_name
FROM schedule s
JOIN course_offering co ON s.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
JOIN teacher t ON co.teacher_id = t.teacher_id
JOIN user u ON t.user_id = u.user_id
JOIN classroom cl ON s.classroom_id = cl.classroom_id
WHERE 1=1
  AND (? IS NULL OR s.classroom_id = ?)
  AND (? IS NULL OR s.day_of_week = ?)
  AND (? IS NULL OR co.semester = ?)
ORDER BY s.day_of_week, s.start_time
LIMIT ? OFFSET ?;
```

### 排课管理页面 - 创建排课
```sql
-- 存储过程 - 检查排课冲突并创建排课
DELIMITER $$
CREATE PROCEDURE sp_create_schedule(
    IN p_offering_id INT,
    IN p_classroom_id INT,
    IN p_day_of_week TINYINT,
    IN p_start_time TIME,
    IN p_end_time TIME,
    IN p_weeks VARCHAR(50),
    OUT p_result INT,
    OUT p_message VARCHAR(255)
)
BEGIN
    DECLARE v_classroom_conflicts INT DEFAULT 0;
    DECLARE v_teacher_conflicts INT DEFAULT 0;
    DECLARE v_teacher_id INT;
    
    -- 获取教师ID
    SELECT teacher_id INTO v_teacher_id
    FROM course_offering
    WHERE offering_id = p_offering_id;
    
    -- 检查教室冲突
    SELECT COUNT(*) INTO v_classroom_conflicts
    FROM schedule s
    WHERE s.classroom_id = p_classroom_id
      AND s.day_of_week = p_day_of_week
      AND ((s.start_time <= p_start_time AND s.end_time > p_start_time)
           OR (s.start_time < p_end_time AND s.end_time >= p_end_time)
           OR (s.start_time >= p_start_time AND s.end_time <= p_end_time));
    
    -- 检查教师冲突
    SELECT COUNT(*) INTO v_teacher_conflicts
    FROM schedule s
    JOIN course_offering co ON s.offering_id = co.offering_id
    WHERE co.teacher_id = v_teacher_id
      AND s.day_of_week = p_day_of_week
      AND ((s.start_time <= p_start_time AND s.end_time > p_start_time)
           OR (s.start_time < p_end_time AND s.end_time >= p_end_time)
           OR (s.start_time >= p_start_time AND s.end_time <= p_end_time));
    
    IF v_classroom_conflicts > 0 THEN
        SET p_result = 1;
        SET p_message = '教室在指定时间已被占用';
    ELSEIF v_teacher_conflicts > 0 THEN
        SET p_result = 2;
        SET p_message = '教师在指定时间已有其他课程安排';
    ELSE
        INSERT INTO schedule (offering_id, classroom_id, day_of_week, start_time, end_time, weeks)
        VALUES (p_offering_id, p_classroom_id, p_day_of_week, p_start_time, p_end_time, p_weeks);
        
        SET p_result = 0;
        SET p_message = '排课成功';
    END IF;
END$$
DELIMITER ;
```

### 排课管理页面 - 更新排课
```sql
-- 更新代码 - 更新排课信息
UPDATE schedule 
SET offering_id = ?, classroom_id = ?, day_of_week = ?, 
    start_time = ?, end_time = ?, weeks = ?
WHERE schedule_id = ?;
```

### 排课管理页面 - 删除排课
```sql
-- 删除代码 - 删除排课
DELETE FROM schedule WHERE schedule_id = ?;
```

### 我的课表页面 - 查看个人课表
```sql
-- 查询代码 - 教师查看自己的课表
SELECT s.*, c.course_name, c.course_code,
       cl.room_no, cl.building, co.semester,
       CASE s.day_of_week
           WHEN 1 THEN '周一'
           WHEN 2 THEN '周二'
           WHEN 3 THEN '周三'
           WHEN 4 THEN '周四'
           WHEN 5 THEN '周五'
           WHEN 6 THEN '周六'
           WHEN 7 THEN '周日'
       END as day_name
FROM schedule s
JOIN course_offering co ON s.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
JOIN classroom cl ON s.classroom_id = cl.classroom_id
WHERE co.teacher_id = (
    SELECT teacher_id FROM teacher WHERE user_id = ?
)
ORDER BY s.day_of_week, s.start_time;

-- 查询代码 - 学生查看自己的课表
SELECT s.*, c.course_name, c.course_code,
       u.real_name as teacher_name,
       cl.room_no, cl.building, co.semester,
       CASE s.day_of_week
           WHEN 1 THEN '周一'
           WHEN 2 THEN '周二'
           WHEN 3 THEN '周三'
           WHEN 4 THEN '周四'
           WHEN 5 THEN '周五'
           WHEN 6 THEN '周六'
           WHEN 7 THEN '周日'
       END as day_name
FROM schedule s
JOIN course_offering co ON s.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
JOIN teacher t ON co.teacher_id = t.teacher_id
JOIN user u ON t.user_id = u.user_id
JOIN classroom cl ON s.classroom_id = cl.classroom_id
JOIN enrollment e ON co.offering_id = e.offering_id
WHERE e.student_id = (
    SELECT student_id FROM student WHERE user_id = ?
)
  AND e.status = 1
ORDER BY s.day_of_week, s.start_time;
```

## 13. 教室管理模块 (classroomApi)

### 教室管理页面 - 教室列表查询
```sql
-- 查询代码 - 分页查询教室列表
SELECT * FROM classroom
WHERE 1=1
  AND (? IS NULL OR room_no LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR building LIKE CONCAT('%', ?, '%'))
  AND (? IS NULL OR room_type = ?)
  AND (? IS NULL OR status = ?)
  AND (? IS NULL OR capacity >= ?)
ORDER BY building, room_no
LIMIT ? OFFSET ?;

-- 查询代码 - 获取所有教室
SELECT * FROM classroom WHERE status = 1 ORDER BY building, room_no;

-- 查询代码 - 按楼栋查询教室
SELECT * FROM classroom WHERE building = ? AND status = 1;

-- 查询代码 - 按类型查询教室
SELECT * FROM classroom WHERE room_type = ? AND status = 1;
```

### 教室管理页面 - 创建教室
```sql
-- 插入代码 - 创建教室
INSERT INTO classroom (room_no, building, floor, capacity, room_type, equipment, status)
VALUES (?, ?, ?, ?, ?, ?, ?);
```

### 教室管理页面 - 更新教室
```sql
-- 更新代码 - 更新教室信息
UPDATE classroom 
SET room_no = ?, building = ?, floor = ?, capacity = ?, 
    room_type = ?, equipment = ?, status = ?
WHERE classroom_id = ?;
```

### 教室管理页面 - 删除教室
```sql
-- 删除代码 - 删除教室
DELETE FROM classroom WHERE classroom_id = ?;

-- 触发器 - 删除教室前检查是否有排课记录
DELIMITER $$
CREATE TRIGGER tr_prevent_classroom_delete_with_schedules
BEFORE DELETE ON classroom
FOR EACH ROW
BEGIN
    DECLARE schedule_count INT;
    SELECT COUNT(*) INTO schedule_count FROM schedule WHERE classroom_id = OLD.classroom_id;
    IF schedule_count > 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '该教室已有排课记录，无法删除';
    END IF;
END$$
DELIMITER ;
```

### 排课页面 - 查询可用教室
```sql
-- 查询代码 - 查询指定时间可用的教室
SELECT c.* FROM classroom c
WHERE c.status = 1
  AND c.classroom_id NOT IN (
    SELECT s.classroom_id
    FROM schedule s
    WHERE s.day_of_week = ?
      AND ((s.start_time <= ? AND s.end_time > ?)
           OR (s.start_time < ? AND s.end_time >= ?)
           OR (s.start_time >= ? AND s.end_time <= ?))
  )
ORDER BY c.building, c.room_no;
```

## 14. 奖惩管理模块 (rewardPunishmentApi)

### 奖惩管理页面 - 奖惩记录列表查询
```sql
-- 查询代码 - 分页查询奖惩记录列表
SELECT rp.*, s.student_no, u.real_name as student_name,
       d.dept_name, s.class_name
FROM reward_punishment rp
JOIN student s ON rp.student_id = s.student_id
JOIN user u ON s.user_id = u.user_id
LEFT JOIN department d ON s.dept_id = d.dept_id
WHERE 1=1
  AND (? IS NULL OR rp.student_id = ?)
  AND (? IS NULL OR rp.type = ?)
  AND (? IS NULL OR rp.category LIKE CONCAT('%', ?, '%'))
ORDER BY rp.occur_date DESC, rp.created_at DESC
LIMIT ? OFFSET ?;
```

### 奖惩管理页面 - 创建奖惩记录
```sql
-- 插入代码 - 创建奖惩记录
INSERT INTO reward_punishment (student_id, type, category, description, occur_date, handler_id, created_at)
VALUES (?, ?, ?, ?, ?, ?, NOW());
```

### 奖惩管理页面 - 更新奖惩记录
```sql
-- 更新代码 - 更新奖惩记录
UPDATE reward_punishment 
SET type = ?, category = ?, description = ?, occur_date = ?
WHERE record_id = ?;
```

### 奖惩管理页面 - 删除奖惩记录
```sql
-- 删除代码 - 删除奖惩记录
DELETE FROM reward_punishment WHERE record_id = ?;
```

### 奖惩统计页面 - 获取奖惩统计信息
```sql
-- 查询代码 - 获取奖惩统计信息
SELECT 
    SUM(CASE WHEN type = '奖励' THEN 1 ELSE 0 END) as total_rewards,
    SUM(CASE WHEN type = '惩罚' THEN 1 ELSE 0 END) as total_punishments,
    COUNT(*) as total_records
FROM reward_punishment;

-- 查询代码 - 获取最近的奖惩记录
SELECT rp.*, s.student_no, u.real_name as student_name
FROM reward_punishment rp
JOIN student s ON rp.student_id = s.student_id
JOIN user u ON s.user_id = u.user_id
ORDER BY rp.created_at DESC
LIMIT 10;

-- 查询代码 - 按类型统计奖惩记录
SELECT type, category, COUNT(*) as count
FROM reward_punishment
GROUP BY type, category
ORDER BY type, count DESC;
```

### 学生奖惩页面 - 按学生查询奖惩记录
```sql
-- 查询代码 - 按学生查询奖惩记录
SELECT * FROM reward_punishment 
WHERE student_id = ?
ORDER BY occur_date DESC;

-- 查询代码 - 按类型查询奖惩记录
SELECT rp.*, s.student_no, u.real_name as student_name
FROM reward_punishment rp
JOIN student s ON rp.student_id = s.student_id
JOIN user u ON s.user_id = u.user_id
WHERE rp.type = ?
ORDER BY rp.occur_date DESC;
```

## 15. 学籍管理模块 (studentStatusApi)

### 学籍管理页面 - 学籍记录列表查询
```sql
-- 查询代码 - 分页查询学籍记录列表
SELECT ss.*, s.student_no, u.real_name as student_name,
       d.dept_name, s.class_name
FROM student_status ss
JOIN student s ON ss.student_id = s.student_id
JOIN user u ON s.user_id = u.user_id
LEFT JOIN department d ON s.dept_id = d.dept_id
WHERE 1=1
  AND (? IS NULL OR ss.student_id = ?)
  AND (? IS NULL OR ss.status_type = ?)
ORDER BY ss.effective_date DESC
LIMIT ? OFFSET ?;
```

### 学籍管理页面 - 创建学籍记录
```sql
-- 插入代码 - 创建学籍记录
INSERT INTO student_status (student_id, status_type, effective_date, end_date, reason, handler_id, created_at)
VALUES (?, ?, ?, ?, ?, ?, NOW());
```

### 学籍管理页面 - 更新学籍记录
```sql
-- 更新代码 - 更新学籍记录
UPDATE student_status 
SET status_type = ?, effective_date = ?, end_date = ?, reason = ?
WHERE status_id = ?;
```

### 学籍管理页面 - 删除学籍记录
```sql
-- 删除代码 - 删除学籍记录
DELETE FROM student_status WHERE status_id = ?;
```

### 学籍查询页面 - 按学生查询学籍记录
```sql
-- 查询代码 - 按学生查询学籍记录
SELECT * FROM student_status 
WHERE student_id = ?
ORDER BY effective_date DESC;

-- 查询代码 - 按类型查询学籍记录
SELECT ss.*, s.student_no, u.real_name as student_name
FROM student_status ss
JOIN student s ON ss.student_id = s.student_id
JOIN user u ON s.user_id = u.user_id
WHERE ss.status_type = ?
ORDER BY ss.effective_date DESC;
```

### 学籍查询页面 - 获取学生当前学籍状态
```sql
-- 查询代码 - 获取学生当前学籍状态
SELECT * FROM student_status 
WHERE student_id = ?
  AND effective_date <= CURDATE()
  AND (end_date IS NULL OR end_date > CURDATE())
ORDER BY effective_date DESC
LIMIT 1;

-- 存储过程 - 获取学生当前学籍状态
DELIMITER $$
CREATE PROCEDURE sp_get_current_student_status(
    IN p_student_id INT,
    OUT p_status_type VARCHAR(50),
    OUT p_effective_date DATE,
    OUT p_reason TEXT
)
BEGIN
    SELECT status_type, effective_date, reason
    INTO p_status_type, p_effective_date, p_reason
    FROM student_status
    WHERE student_id = p_student_id
      AND effective_date <= CURDATE()
      AND (end_date IS NULL OR end_date > CURDATE())
    ORDER BY effective_date DESC
    LIMIT 1;
END$$
DELIMITER ;
```

## 16. 统计分析相关功能

### 数据统计视图
```sql
-- 视图 - 学生成绩统计
CREATE VIEW v_student_grade_statistics AS
SELECT 
    s.student_id,
    s.student_no,
    u.real_name as student_name,
    s.class_name,
    s.grade,
    COUNT(g.grade_id) as total_courses,
    AVG(g.final_score) as average_score,
    SUM(CASE WHEN g.final_score >= 60 THEN c.credits ELSE 0 END) as earned_credits,
    SUM(CASE WHEN g.final_score >= 60 THEN 1 ELSE 0 END) as passed_courses,
    SUM(CASE WHEN g.final_score < 60 THEN 1 ELSE 0 END) as failed_courses,
    AVG(g.grade_point) as gpa
FROM student s
JOIN user u ON s.user_id = u.user_id
JOIN enrollment e ON s.student_id = e.student_id
JOIN course_offering co ON e.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
WHERE g.final_score IS NOT NULL
GROUP BY s.student_id, s.student_no, u.real_name, s.class_name, s.grade;

-- 视图 - 教师教学统计
CREATE VIEW v_teacher_teaching_statistics AS
SELECT 
    t.teacher_id,
    t.teacher_no,
    u.real_name as teacher_name,
    t.title,
    d.dept_name,
    COUNT(DISTINCT co.offering_id) as total_offerings,
    COUNT(DISTINCT c.course_id) as total_courses,
    SUM(co.current_students)
```

继续生成教师教学统计视图和其他统计分析功能：

```sql
-- 视图 - 教师教学统计
CREATE VIEW v_teacher_teaching_statistics AS
SELECT 
    t.teacher_id,
    t.teacher_no,
    u.real_name as teacher_name,
    t.title,
    d.dept_name,
    COUNT(DISTINCT co.offering_id) as total_offerings,
    COUNT(DISTINCT c.course_id) as total_courses,
    SUM(co.current_students) as total_students,
    AVG(g.final_score) as average_grade,
    COUNT(DISTINCT co.semester) as semesters_taught
FROM teacher t
JOIN user u ON t.user_id = u.user_id
LEFT JOIN department d ON t.dept_id = d.dept_id
JOIN course_offering co ON t.teacher_id = co.teacher_id
JOIN course c ON co.course_id = c.course_id
JOIN enrollment e ON co.offering_id = e.offering_id
LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
GROUP BY t.teacher_id, t.teacher_no, u.real_name, t.title, d.dept_name;

-- 视图 - 课程统计
CREATE VIEW v_course_statistics AS
SELECT 
    c.course_id,
    c.course_name,
    c.course_code,
    c.credits,
    c.course_type,
    d.dept_name,
    COUNT(DISTINCT co.offering_id) as total_offerings,
    COUNT(DISTINCT e.student_id) as total_enrollments,
    AVG(g.final_score) as average_score,
    ROUND(SUM(CASE WHEN g.final_score >= 60 THEN 1 ELSE 0 END) * 100.0 / COUNT(g.grade_id), 2) as pass_rate,
    COUNT(DISTINCT co.teacher_id) as teachers_count
FROM course c
LEFT JOIN department d ON c.dept_id = d.dept_id
LEFT JOIN course_offering co ON c.course_id = co.course_id
LEFT JOIN enrollment e ON co.offering_id = e.offering_id
LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
WHERE g.final_score IS NOT NULL
GROUP BY c.course_id, c.course_name, c.course_code, c.credits, c.course_type, d.dept_name;

-- 视图 - 部门统计
CREATE VIEW v_department_statistics AS
SELECT 
    d.dept_id,
    d.dept_name,
    COUNT(DISTINCT s.student_id) as student_count,
    COUNT(DISTINCT t.teacher_id) as teacher_count,
    COUNT(DISTINCT c.course_id) as course_count,
    AVG(g.final_score) as avg_student_score
FROM department d
LEFT JOIN student s ON d.dept_id = s.dept_id
LEFT JOIN teacher t ON d.dept_id = t.dept_id
LEFT JOIN course c ON d.dept_id = c.dept_id
LEFT JOIN course_offering co ON c.course_id = co.course_id
LEFT JOIN enrollment e ON co.offering_id = e.offering_id
LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
GROUP BY d.dept_id, d.dept_name;
```

### 统计分析存储过程

```sql
-- 存储过程 - 生成学期统计报告
DELIMITER $$
CREATE PROCEDURE sp_semester_statistics_report(
    IN p_semester VARCHAR(20)
)
BEGIN
    -- 创建临时报告表
    CREATE TEMPORARY TABLE temp_semester_report (
        report_type VARCHAR(50),
        metric_name VARCHAR(100),
        metric_value VARCHAR(100)
    );
    
    -- 统计开课数量
    INSERT INTO temp_semester_report
    SELECT 'course_statistics', '开课总数', COUNT(*)
    FROM course_offering
    WHERE semester = p_semester;
    
    -- 统计选课人数
    INSERT INTO temp_semester_report
    SELECT 'enrollment_statistics', '选课总人次', COUNT(*)
    FROM enrollment e
    JOIN course_offering co ON e.offering_id = co.offering_id
    WHERE co.semester = p_semester;
    
    -- 统计平均分
    INSERT INTO temp_semester_report
    SELECT 'grade_statistics', '平均分', ROUND(AVG(g.final_score), 2)
    FROM grade g
    JOIN enrollment e ON g.enrollment_id = e.enrollment_id
    JOIN course_offering co ON e.offering_id = co.offering_id
    WHERE co.semester = p_semester AND g.final_score IS NOT NULL;
    
    -- 统计及格率
    INSERT INTO temp_semester_report
    SELECT 'grade_statistics', '及格率(%)', 
           ROUND(SUM(CASE WHEN g.final_score >= 60 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2)
    FROM grade g
    JOIN enrollment e ON g.enrollment_id = e.enrollment_id
    JOIN course_offering co ON e.offering_id = co.offering_id
    WHERE co.semester = p_semester AND g.final_score IS NOT NULL;
    
    -- 统计优秀率
    INSERT INTO temp_semester_report
    SELECT 'grade_statistics', '优秀率(%)', 
           ROUND(SUM(CASE WHEN g.final_score >= 90 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2)
    FROM grade g
    JOIN enrollment e ON g.enrollment_id = e.enrollment_id
    JOIN course_offering co ON e.offering_id = co.offering_id
    WHERE co.semester = p_semester AND g.final_score IS NOT NULL;
    
    -- 统计不及格人次
    INSERT INTO temp_semester_report
    SELECT 'grade_statistics', '不及格人次', 
           SUM(CASE WHEN g.final_score < 60 THEN 1 ELSE 0 END)
    FROM grade g
    JOIN enrollment e ON g.enrollment_id = e.enrollment_id
    JOIN course_offering co ON e.offering_id = co.offering_id
    WHERE co.semester = p_semester AND g.final_score IS NOT NULL;
    
    -- 返回报告结果
    SELECT * FROM temp_semester_report ORDER BY report_type, metric_name;
    
    DROP TEMPORARY TABLE temp_semester_report;
END$$
DELIMITER ;

-- 存储过程 - 班级成绩分析
DELIMITER $$
CREATE PROCEDURE sp_class_grade_analysis(
    IN p_class_name VARCHAR(50),
    IN p_semester VARCHAR(20)
)
BEGIN
    SELECT 
        c.course_name,
        c.course_code,
        COUNT(g.grade_id) as student_count,
        AVG(g.final_score) as avg_score,
        MAX(g.final_score) as max_score,
        MIN(g.final_score) as min_score,
        ROUND(SUM(CASE WHEN g.final_score >= 90 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as excellent_rate,
        ROUND(SUM(CASE WHEN g.final_score >= 60 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as pass_rate,
        u.real_name as teacher_name
    FROM grade g
    JOIN enrollment e ON g.enrollment_id = e.enrollment_id
    JOIN student s ON e.student_id = s.student_id
    JOIN course_offering co ON e.offering_id = co.offering_id
    JOIN course c ON co.course_id = c.course_id
    JOIN teacher t ON co.teacher_id = t.teacher_id
    JOIN user u ON t.user_id = u.user_id
    WHERE s.class_name = p_class_name 
      AND co.semester = p_semester
      AND g.final_score IS NOT NULL
    GROUP BY c.course_id, c.course_name, c.course_code, u.real_name
    ORDER BY c.course_name;
END$$
DELIMITER ;

-- 存储过程 - 教师教学质量分析
DELIMITER $$
CREATE PROCEDURE sp_teacher_quality_analysis(
    IN p_teacher_id INT,
    IN p_semester VARCHAR(20)
)
BEGIN
    SELECT 
        c.course_name,
        c.course_code,
        co.max_students,
        co.current_students,
        ROUND(co.current_students * 100.0 / co.max_students, 2) as enrollment_rate,
        COUNT(g.grade_id) as graded_students,
        AVG(g.final_score) as avg_score,
        ROUND(SUM(CASE WHEN g.final_score >= 90 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as excellent_rate,
        ROUND(SUM(CASE WHEN g.final_score >= 60 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) as pass_rate
    FROM course_offering co
    JOIN course c ON co.course_id = c.course_id
    JOIN enrollment e ON co.offering_id = e.offering_id
    LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
    WHERE co.teacher_id = p_teacher_id
      AND co.semester = p_semester
      AND g.final_score IS NOT NULL
    GROUP BY co.offering_id, c.course_name, c.course_code, co.max_students, co.current_students
    ORDER BY c.course_name;
END$$
DELIMITER ;

-- 存储过程 - 学生学习情况分析
DELIMITER $$
CREATE PROCEDURE sp_student_learning_analysis(
    IN p_student_id INT
)
BEGIN
    -- 基本信息
    SELECT 
        s.student_no,
        u.real_name,
        s.class_name,
        s.grade,
        s.enrollment_year,
        d.dept_name
    FROM student s
    JOIN user u ON s.user_id = u.user_id
    LEFT JOIN department d ON s.dept_id = d.dept_id
    WHERE s.student_id = p_student_id;
    
    -- 成绩统计
    SELECT 
        COUNT(g.grade_id) as total_courses,
        AVG(g.final_score) as avg_score,
        AVG(g.grade_point) as gpa,
        SUM(CASE WHEN g.final_score >= 60 THEN c.credits ELSE 0 END) as earned_credits,
        SUM(c.credits) as total_credits,
        SUM(CASE WHEN g.final_score >= 90 THEN 1 ELSE 0 END) as excellent_count,
        SUM(CASE WHEN g.final_score >= 60 THEN 1 ELSE 0 END) as pass_count,
        SUM(CASE WHEN g.final_score < 60 THEN 1 ELSE 0 END) as fail_count
    FROM enrollment e
    JOIN course_offering co ON e.offering_id = co.offering_id
    JOIN course c ON co.course_id = c.course_id
    LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
    WHERE e.student_id = p_student_id AND g.final_score IS NOT NULL;
    
    -- 各学期成绩趋势
    SELECT 
        co.semester,
        COUNT(g.grade_id) as course_count,
        AVG(g.final_score) as avg_score,
        AVG(g.grade_point) as semester_gpa
    FROM enrollment e
    JOIN course_offering co ON e.offering_id = co.offering_id
    LEFT JOIN grade g ON e.enrollment_id = g.enrollment_id
    WHERE e.student_id = p_student_id AND g.final_score IS NOT NULL
    GROUP BY co.semester
    ORDER BY co.semester;
END$$
DELIMITER ;
```

### 审计日志相关功能

```sql
-- 创建审计日志表
CREATE TABLE audit_log (
    log_id INT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(50) NOT NULL,
    operation_type ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL,
    record_id INT,
    old_values JSON,
    new_values JSON,
    user_id INT,
    operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR(45),
    user_agent TEXT,
    CONSTRAINT fk_audit_log_user FOREIGN KEY (user_id) REFERENCES user(user_id)
);

-- 通用审计触发器 - 用户表
DELIMITER $$
CREATE TRIGGER tr_user_audit_insert
AFTER INSERT ON user
FOR EACH ROW
BEGIN
    INSERT INTO audit_log (table_name, operation_type, record_id, new_values, user_id, ip_address)
    VALUES ('user', 'INSERT', NEW.user_id, 
            JSON_OBJECT('username', NEW.username, 'real_name', NEW.real_name, 'email', NEW.email, 'status', NEW.status),
            @current_user_id, @client_ip);
END$$

CREATE TRIGGER tr_user_audit_update
AFTER UPDATE ON user
FOR EACH ROW
BEGIN
    INSERT INTO audit_log (table_name, operation_type, record_id, old_values, new_values, user_id, ip_address)
    VALUES ('user', 'UPDATE', NEW.user_id,
            JSON_OBJECT('username', OLD.username, 'real_name', OLD.real_name, 'email', OLD.email, 'status', OLD.status),
            JSON_OBJECT('username', NEW.username, 'real_name', NEW.real_name, 'email', NEW.email, 'status', NEW.status),
            @current_user_id, @client_ip);
END$$

CREATE TRIGGER tr_user_audit_delete
BEFORE DELETE ON user
FOR EACH ROW
BEGIN
    INSERT INTO audit_log (table_name, operation_type, record_id, old_values, user_id, ip_address)
    VALUES ('user', 'DELETE', OLD.user_id,
            JSON_OBJECT('username', OLD.username, 'real_name', OLD.real_name, 'email', OLD.email, 'status', OLD.status),
            @current_user_id, @client_ip);
END$$
DELIMITER ;

-- 成绩审计触发器
DELIMITER $$
CREATE TRIGGER tr_grade_audit_insert
AFTER INSERT ON grade
FOR EACH ROW
BEGIN
    INSERT INTO audit_log (table_name, operation_type, record_id, new_values, user_id, ip_address)
    VALUES ('grade', 'INSERT', NEW.grade_id, 
            JSON_OBJECT('enrollment_id', NEW.enrollment_id, 'usual_score', NEW.usual_score, 
                       'exam_score', NEW.exam_score, 'final_score', NEW.final_score),
            @current_user_id, @client_ip);
END$$

CREATE TRIGGER tr_grade_audit_update
AFTER UPDATE ON grade
FOR EACH ROW
BEGIN
    INSERT INTO audit_log (table_name, operation_type, record_id, old_values, new_values, user_id, ip_address)
    VALUES ('grade', 'UPDATE', NEW.grade_id,
            JSON_OBJECT('usual_score', OLD.usual_score, 'exam_score', OLD.exam_score, 'final_score', OLD.final_score),
            JSON_OBJECT('usual_score', NEW.usual_score, 'exam_score', NEW.exam_score, 'final_score', NEW.final_score),
            @current_user_id, @client_ip);
END$$
DELIMITER ;
```

### 系统维护功能

```sql
-- 存储过程 - 数据完整性检查
DELIMITER $$
CREATE PROCEDURE sp_data_integrity_check()
BEGIN
    DECLARE v_error_count INT DEFAULT 0;
    DECLARE v_error_msg TEXT DEFAULT '';
    
    -- 检查用户角色关联
    SELECT COUNT(*) INTO @temp_count
    FROM user_role ur
    LEFT JOIN user u ON ur.user_id = u.user_id
    LEFT JOIN role r ON ur.role_id = r.role_id
    WHERE u.user_id IS NULL OR r.role_id IS NULL;
    
    IF @temp_count > 0 THEN
        SET v_error_count = v_error_count + @temp_count;
        SET v_error_msg = CONCAT(v_error_msg, '用户角色关联表存在无效记录:', @temp_count, '条; ');
    END IF;
    
    -- 检查教师用户关联
    SELECT COUNT(*) INTO @temp_count
    FROM teacher t
    LEFT JOIN user u ON t.user_id = u.user_id
    WHERE u.user_id IS NULL;
    
    IF @temp_count > 0 THEN
        SET v_error_count = v_error_count + @temp_count;
        SET v_error_msg = CONCAT(v_error_msg, '教师表存在无效用户关联:', @temp_count, '条; ');
    END IF;
    
    -- 检查学生用户关联
    SELECT COUNT(*) INTO @temp_count
    FROM student s
    LEFT JOIN user u ON s.user_id = u.user_id
    WHERE u.user_id IS NULL;
    
    IF @temp_count > 0 THEN
        SET v_error_count = v_error_count + @temp_count;
        SET v_error_msg = CONCAT(v_error_msg, '学生表存在无效用户关联:', @temp_count, '条; ');
    END IF;
    
    -- 检查选课记录
    SELECT COUNT(*) INTO @temp_count
    FROM enrollment e
    LEFT JOIN student s ON e.student_id = s.student_id
    LEFT JOIN course_offering co ON e.offering_id = co.offering_id
    WHERE s.student_id IS NULL OR co.offering_id IS NULL;
    
    IF @temp_count > 0 THEN
        SET v_error_count = v_error_count + @temp_count;
        SET v_error_msg = CONCAT(v_error_msg, '选课记录存在无效关联:', @temp_count, '条; ');
    END IF;
    
    -- 检查成绩记录
    SELECT COUNT(*) INTO @temp_count
    FROM grade g
    LEFT JOIN enrollment e ON g.enrollment_id = e.enrollment_id
    WHERE e.enrollment_id IS NULL;
    
    IF @temp_count > 0 THEN
        SET v_error_count = v_error_count + @temp_count;
        SET v_error_msg = CONCAT(v_error_msg, '成绩记录存在无效选课关联:', @temp_count, '条; ');
    END IF;
    
    -- 输出检查结果
    SELECT v_error_count as error_count, v_error_msg as error_details;
END$$
DELIMITER ;

-- 存储过程 - 清理过期数据
DELIMITER $$
CREATE PROCEDURE sp_cleanup_expired_data()
BEGIN
    DECLARE cleaned_count INT DEFAULT 0;
    
    -- 清理30天前的审计日志
    DELETE FROM audit_log 
    WHERE operation_time < DATE_SUB(NOW(), INTERVAL 30 DAY);
    
    SET cleaned_count = ROW_COUNT();
    
    SELECT CONCAT('清理了 ', cleaned_count, ' 条过期审计日志') as result;
END$$
DELIMITER ;

-- 存储过程 - 数据库优化
DELIMITER $$
CREATE PROCEDURE sp_optimize_database()
BEGIN
    -- 分析表
    ANALYZE TABLE user, teacher, student, course, course_offering, 
                 enrollment, grade, schedule, classroom, department;
    
    -- 优化表
    OPTIMIZE TABLE user, teacher, student, course, course_offering, 
                   enrollment, grade, schedule, classroom, department;
    
    SELECT 'Database optimization completed' as result;
END$$
DELIMITER ;
```

### 批量操作功能

```sql
-- 存储过程 - 批量导入学生
DELIMITER $$
CREATE PROCEDURE sp_batch_import_students(
    IN p_student_data JSON
)
BEGIN
    DECLARE i INT DEFAULT 0;
    DECLARE v_count INT;
    DECLARE v_username VARCHAR(50);
    DECLARE v_real_name VARCHAR(20);
    DECLARE v_email VARCHAR(100);
    DECLARE v_phone VARCHAR(11);
    DECLARE v_student_no VARCHAR(20);
    DECLARE v_dept_id INT;
    DECLARE v_class_name VARCHAR(50);
    DECLARE v_grade INT;
    DECLARE v_enrollment_year YEAR;
    DECLARE v_user_id INT;
    DECLARE v_success_count INT DEFAULT 0;
    DECLARE v_error_count INT DEFAULT 0;
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT CONCAT('导入失败，已回滚。成功:', v_success_count, '条，失败:', v_error_count, '条') as result;
    END;
    
    SET v_count = JSON_LENGTH(p_student_data);
    START TRANSACTION;
    
    WHILE i < v_count DO
        BEGIN
            DECLARE CONTINUE HANDLER FOR SQLEXCEPTION 
            BEGIN
                SET v_error_count = v_error_count + 1;
            END;
            
            SET v_username = JSON_UNQUOTE(JSON_EXTRACT(p_student_data, CONCAT('$[', i, '].username')));
            SET v_real_name = JSON_UNQUOTE(JSON_EXTRACT(p_student_data, CONCAT('$[', i, '].real_name')));
            SET v_email = JSON_UNQUOTE(JSON_EXTRACT(p_student_data, CONCAT('$[', i, '].email')));
            SET v_phone = JSON_UNQUOTE(JSON_EXTRACT(p_student_data, CONCAT('$[', i, '].phone')));
            SET v_student_no = JSON_UNQUOTE(JSON_EXTRACT(p_student_data, CONCAT('$[', i, '].student_no')));
            SET v_dept_id = JSON_UNQUOTE(JSON_EXTRACT(p_student_data, CONCAT('$[', i, '].dept_id')));
            SET v_class_name = JSON_UNQUOTE(JSON_EXTRACT(p_student_data, CONCAT('$[', i, '].class_name')));
            SET v_grade = JSON_UNQUOTE(JSON_EXTRACT(p_student_data, CONCAT('$[', i, '].grade')));
            SET v_enrollment_year = JSON_UNQUOTE(JSON_EXTRACT(p_student_data, CONCAT('$[', i, '].enrollment_year')));
            
            -- 创建用户
            INSERT INTO user (username, real_name, email, phone, password, status, created_at, updated_at)
            VALUES (v_username, v_real_name, v_email, v_phone, '123456', 1, NOW(), NOW());
            
            SET v_user_id = LAST_INSERT_ID();
            
            -- 创建学生
            INSERT INTO student (user_id, student_no, dept_id, class_name, grade, enrollment_year)
            VALUES (v_user_id, v_student_no, v_dept_id, v_class_name, v_grade, v_enrollment_year);
            
            SET v_success_count = v_success_count + 1;
        END;
        
        SET i = i + 1;
    END WHILE;
    
    COMMIT;
    SELECT CONCAT('导入完成。成功:', v_success_count, '条，失败:', v_error_count, '条') as result;
END$$
DELIMITER ;

-- 存储过程 - 批量更新成绩
DELIMITER $$
CREATE PROCEDURE sp_batch_update_grades_by_course(
    IN p_offering_id INT,
    IN p_grade_data JSON
)
BEGIN
    DECLARE i INT DEFAULT 0;
    DECLARE v_count INT;
    DECLARE v_student_no VARCHAR(20);
    DECLARE v_usual_score DECIMAL(5,2);
    DECLARE v_exam_score DECIMAL(5,2);
    DECLARE v_enrollment_id INT;
    DECLARE v_success_count INT DEFAULT 0;
    DECLARE v_error_count INT DEFAULT 0;
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT CONCAT('更新失败，已回滚。成功:', v_success_count, '条，失败:', v_error_count, '条') as result;
    END;
    
    SET v_count = JSON_LENGTH(p_grade_data);
    START TRANSACTION;
    
    WHILE i < v_count DO
        BEGIN
            DECLARE CONTINUE HANDLER FOR SQLEXCEPTION 
            BEGIN
                SET v_error_count = v_error_count + 1;
            END;
            
            SET v_student_no = JSON_UNQUOTE(JSON_EXTRACT(p_grade_data, CONCAT('$[', i, '].student_no')));
            SET v_usual_score = JSON_UNQUOTE(JSON_EXTRACT(p_grade_data, CONCAT('$[', i, '].usual_score')));
            SET v_exam_score = JSON_UNQUOTE(JSON_EXTRACT(p_grade_data, CONCAT('$[', i, '].exam_score')));
            
            -- 获取选课记录ID
            SELECT e.enrollment_id INTO v_enrollment_id
            FROM enrollment e
            JOIN student s ON e.student_id = s.student_id
            WHERE s.student_no = v_student_no AND e.offering_id = p_offering_id;
            
            -- 插入或更新成绩
            INSERT INTO grade (enrollment_id, usual_score, exam_score, recorded_by, recorded_at)
            VALUES (v_enrollment_id, v_usual_score, v_exam_score, @current_user_id, NOW())
            ON DUPLICATE KEY UPDATE
                usual_score = VALUES(usual_score),
                exam_score = VALUES(exam_score),
                recorded_by = VALUES(recorded_by),
                recorded_at = NOW();
            
            SET v_success_count = v_success_count + 1;
        END;
        
        SET i = i + 1;
    END WHILE;
    
    COMMIT;
    SELECT CONCAT('成绩更新完成。成功:', v_success_count, '条，失败:', v_error_count, '条') as result;
END$$
DELIMITER ;
```

### 常用查询功能

```sql
-- 查询代码 - 获取系统概览统计
SELECT 
    (SELECT COUNT(*) FROM user WHERE status = 1) as active_users,
    (SELECT COUNT(*) FROM student) as total_students,
    (SELECT COUNT(*) FROM teacher WHERE status = 1) as active_teachers,
    (SELECT COUNT(*) FROM course WHERE status = 1) as active_courses,
    (SELECT COUNT(*) FROM course_offering WHERE status = 1) as current_offerings,
    (SELECT COUNT(*) FROM enrollment WHERE status = 1) as total_enrollments;

-- 查询代码 - 获取最近活动
SELECT 
    'enrollment' as activity_type,
    CONCAT(u.real_name, ' 选择了课程 ', c.course_name) as description,
    e.enrollment_date as activity_time
FROM enrollment e
JOIN student s ON e.student_id = s.student_id
JOIN user u ON s.user_id = u.user_id
JOIN course_offering co ON e.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
WHERE e.enrollment_date >= DATE_SUB(NOW(), INTERVAL 7 DAY)

UNION ALL

SELECT 
    'grade' as activity_type,
    CONCAT('课程 ', c.course_name, ' 的成绩已录入') as description,
    g.recorded_at as activity_time
FROM grade g
JOIN enrollment e ON g.enrollment_id = e.enrollment_id
JOIN course_offering co ON e.offering_id = co.offering_id
JOIN course c ON co.course_id = c.course_id
WHERE g.recorded_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)

ORDER BY activity_time DESC
LIMIT 20;

-- 查询代码 - 搜索功能
SELECT 'student' as type, s.student_no as code, u.real_name as name, s.class_name as extra_info
FROM student s
JOIN user u ON s.user_id = u.user_id
WHERE u.real_name LIKE CONCAT('%', ?, '%') OR s.student_no LIKE CONCAT('%', ?, '%')

UNION ALL

SELECT 'teacher' as type, t.teacher_no as code, u.real_name as name, t.title as extra_info
FROM teacher t
JOIN user u ON t.user_id = u.user_id
WHERE u.real_name LIKE CONCAT('%', ?, '%') OR t.teacher_no LIKE CONCAT('%', ?, '%')

UNION ALL

SELECT 'course' as type, c.course_code as code, c.course_name as name, c.course_type as extra_info
FROM course c
WHERE c.course_name LIKE CONCAT('%', ?, '%') OR c.course_code LIKE CONCAT('%', ?, '%')

LIMIT 50;
```
